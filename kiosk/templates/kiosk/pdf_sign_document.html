{% extends 'base.html' %}

{% block title %}Review & Sign Document - Smart Hotel{% endblock %}

{% block extra_css %}
<style>
.pdf-sign-page {
    min-height: 100vh;
    padding: 2rem;
    background: #f5f7fa;
}

.pdf-sign-container {
    max-width: 1000px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.page-header .icon-box {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
}

.page-header .icon-box svg {
    width: 28px;
    height: 28px;
    color: #fff;
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a2e;
    margin: 0;
}

.page-header p {
    color: #6c757d;
    margin: 0.25rem 0 0;
    font-size: 0.95rem;
}

/* PDF Document Card */
.pdf-document-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.pdf-document-header {
    background: #1a1a2e;
    color: #fff;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.pdf-document-header h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pdf-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.pdf-controls .mode-indicator {
    background: rgba(102, 126, 234, 0.3);
    color: #a5b4fc;
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    margin-right: 0.5rem;
}

.pdf-controls .mode-indicator.signing {
    background: rgba(16, 185, 129, 0.3);
    color: #6ee7b7;
}

.pdf-controls button {
    background: rgba(255,255,255,0.1);
    border: none;
    color: #fff;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}

.pdf-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.pdf-controls button.active {
    background: #667eea;
}

/* PDF Canvas Container */
.pdf-canvas-wrapper {
    position: relative;
    background: #525659;
    min-height: 700px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    overflow: auto;
}

.pdf-page-container {
    position: relative;
    background: #fff;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    margin-bottom: 1rem;
}

#pdfCanvas {
    display: block;
}

#signatureOverlay {
    position: absolute;
    top: 0;
    left: 0;
    cursor: default;
    touch-action: none;
}

#signatureOverlay.signing-mode {
    cursor: crosshair;
}

/* PDF Loading and Error states */
.pdf-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: #fff;
    width: 100%;
    min-height: 500px;
}

.pdf-loading .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.pdf-error {
    color: #f87171;
    text-align: center;
    padding: 2rem;
    width: 100%;
}

.pdf-error p {
    margin-bottom: 1rem;
}

.pdf-error button {
    background: #667eea;
    color: #fff;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
}

/* Action Panel */
.action-panel {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 1.5rem;
}

.action-panel h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.signature-tools {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.tool-btn {
    flex: 1;
    min-width: 100px;
    padding: 0.75rem 1rem;
    border: 2px solid #dee2e6;
    background: #fff;
    border-radius: 10px;
    font-size: 0.9rem;
    color: #495057;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.tool-btn:hover {
    background: #f8f9fa;
    border-color: #ced4da;
}

.tool-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: #fff;
}

.tool-btn.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.tool-btn.success {
    background: #10b981;
    border-color: transparent;
    color: #fff;
}

.tool-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.divider {
    display: flex;
    align-items: center;
    margin: 1.5rem 0;
    color: #adb5bd;
    font-size: 0.85rem;
}

.divider::before,
.divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #dee2e6;
}

.divider span {
    padding: 0 1rem;
}

.print-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
}

.print-section h4 {
    font-size: 0.95rem;
    color: #495057;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.print-section p {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.print-btn {
    width: 100%;
    padding: 0.875rem;
    background: #fff;
    border: 2px solid #495057;
    border-radius: 10px;
    color: #495057;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.print-btn:hover {
    background: #495057;
    color: #fff;
}

/* Confirmation Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: #fff;
    border-radius: 20px;
    max-width: 500px;
    width: 100%;
    padding: 2rem;
    text-align: center;
}

.modal-content .icon-success {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
}

.modal-content .icon-success svg {
    width: 40px;
    height: 40px;
    color: #fff;
}

.modal-content h2 {
    font-size: 1.5rem;
    color: #1a1a2e;
    margin-bottom: 0.75rem;
}

.modal-content p {
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.modal-content .btn-continue {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Print Confirmation Modal */
.modal-content.print-confirm .icon-success {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.signature-preview {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.signature-preview img {
    max-width: 100%;
    max-height: 100px;
}

.signature-preview-placeholder {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
}

.back-link {
    display: block;
    text-align: center;
    margin-top: 1.5rem;
    color: #6c757d;
    text-decoration: none;
    font-size: 0.9rem;
}

.back-link:hover {
    color: #495057;
}

/* Status Message */
.status-message {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: #1a1a2e;
    color: #fff;
    padding: 0.875rem 1.5rem;
    border-radius: 50px;
    font-size: 0.9rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    display: none;
    align-items: center;
    gap: 0.5rem;
    z-index: 100;
}

.status-message.show {
    display: flex;
}

.status-message.success {
    background: #10b981;
}
</style>
{% endblock %}

{% block content %}
<div class="pdf-sign-page">
    <div class="pdf-sign-container">
        <div class="page-header">
            <div class="icon-box">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/>
                    <path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                </svg>
            </div>
            <div>
                <h1 data-i18n="review_and_sign">Review & Sign Document</h1>
                <p data-i18n="sign_on_pdf_instruction">Sign directly on the document below or print for physical signature</p>
            </div>
        </div>

        <!-- PDF Document with Signature Overlay -->
        <div class="pdf-document-card">
            <div class="pdf-document-header">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                        <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a10.954 10.954 0 0 0 .98 1.686 5.753 5.753 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.856.856 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.712 5.712 0 0 1-.911-.95 11.651 11.651 0 0 0-1.997.406 11.307 11.307 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.793.793 0 0 1-.58.029z"/>
                    </svg>
                    <span data-i18n="registration_document">Registration Document</span>
                </h3>
                <div class="pdf-controls">
                    <span class="mode-indicator" id="modeIndicator" data-i18n="viewing_mode">Viewing</span>
                    <button type="button" id="signModeBtn" title="Enable Signing">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/>
                            <path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/>
                        </svg>
                    </button>
                    <button type="button" id="zoomOutBtn" title="Zoom Out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                            <path fill-rule="evenodd" d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                    </button>
                    <button type="button" id="zoomInBtn" title="Zoom In">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                            <path d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="pdf-canvas-wrapper" id="pdfWrapper">
                <div class="pdf-loading" id="pdfLoading">
                    <div class="spinner"></div>
                    <span data-i18n="loading_document">Loading document...</span>
                </div>
                <div class="pdf-error" id="pdfError" style="display: none;">
                    <p data-i18n="pdf_load_error">Unable to load document. Please try again.</p>
                    <button onclick="location.reload()" data-i18n="retry">Retry</button>
                </div>
                <div class="pdf-page-container" id="pageContainer" style="display: none;">
                    <canvas id="pdfCanvas"></canvas>
                    <canvas id="signatureOverlay"></canvas>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="action-panel">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/>
                    <path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/>
                </svg>
                <span data-i18n="signature_tools">Signature Tools</span>
            </h3>

            <div class="signature-tools">
                <button type="button" class="tool-btn primary" id="enableSignBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/>
                        <path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/>
                    </svg>
                    <span data-i18n="start_signing">Start Signing</span>
                </button>
                <button type="button" class="tool-btn" id="clearSignatureBtn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5z"/>
                    </svg>
                    <span data-i18n="clear">Clear</span>
                </button>
                <button type="button" class="tool-btn success" id="confirmSignatureBtn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                    </svg>
                    <span data-i18n="confirm_signature">Confirm Signature</span>
                </button>
            </div>

            <div class="divider">
                <span data-i18n="or">OR</span>
            </div>

            <div class="print-section">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                        <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"/>
                    </svg>
                    <span data-i18n="prefer_physical_signature">Prefer to sign on paper?</span>
                </h4>
                <p data-i18n="print_instruction">Print the document and sign it physically at the front desk</p>
                <button type="button" class="print-btn" id="printDocumentBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                        <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"/>
                    </svg>
                    <span data-i18n="print_document">Print Document</span>
                </button>
            </div>

            <a href="{% url 'kiosk:dw_registration_card' %}" class="back-link" data-i18n="back_to_edit">
                ‚Üê Back to Edit Information
            </a>
        </div>
    </div>
</div>

<!-- Signature Confirmation Modal -->
<div class="modal-overlay" id="signatureConfirmModal">
    <div class="modal-content">
        <div class="icon-success">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
        </div>
        <h2 data-i18n="signature_confirmed">Signature Confirmed</h2>
        <p data-i18n="signature_saved_message">Your digital signature has been saved to the document.</p>
        <div class="signature-preview" id="signaturePreviewContainer">
            <img id="signaturePreviewImg" src="" alt="Your signature">
        </div>
        <form method="post" id="confirmSignatureForm">
            {% csrf_token %}
            <input type="hidden" name="signature_data" id="signatureDataInput" value="">
            <input type="hidden" name="signature_svg" id="signatureSvgInput" value="">
            <input type="hidden" name="signature_type" value="digital">
            <button type="submit" class="btn-continue">
                <span data-i18n="continue_to_access">Continue to Access Method</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/>
                </svg>
            </button>
        </form>
    </div>
</div>

<!-- Print Confirmation Modal -->
<div class="modal-overlay" id="printConfirmModal">
    <div class="modal-content print-confirm">
        <div class="icon-success">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"/>
            </svg>
        </div>
        <h2 data-i18n="document_sent_to_printer">Document Sent to Printer</h2>
        <p data-i18n="print_instruction_desk">Please sign the printed document at the front desk and hand it to our staff.</p>
        <form method="post" id="printConfirmForm">
            {% csrf_token %}
            <input type="hidden" name="signature_type" value="physical">
            <button type="submit" class="btn-continue">
                <span data-i18n="continue_to_access">Continue to Access Method</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/>
                </svg>
            </button>
        </form>
    </div>
</div>

<!-- Status Message -->
<div class="status-message" id="statusMessage">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
    </svg>
    <span id="statusText"></span>
</div>

<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Configure PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const pdfCanvas = document.getElementById('pdfCanvas');
    const signatureOverlay = document.getElementById('signatureOverlay');
    const pageContainer = document.getElementById('pageContainer');
    const pdfLoading = document.getElementById('pdfLoading');
    const pdfError = document.getElementById('pdfError');
    const modeIndicator = document.getElementById('modeIndicator');
    
    const enableSignBtn = document.getElementById('enableSignBtn');
    const signModeBtn = document.getElementById('signModeBtn');
    const clearSignatureBtn = document.getElementById('clearSignatureBtn');
    const confirmSignatureBtn = document.getElementById('confirmSignatureBtn');
    const printDocumentBtn = document.getElementById('printDocumentBtn');
    
    const signatureConfirmModal = document.getElementById('signatureConfirmModal');
    const printConfirmModal = document.getElementById('printConfirmModal');
    const signaturePreviewImg = document.getElementById('signaturePreviewImg');
    const signatureDataInput = document.getElementById('signatureDataInput');
    const signatureSvgInput = document.getElementById('signatureSvgInput');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');

    // State
    let pdfDoc = null;
    let currentScale = 1.5;
    let isSigningMode = false;
    let isDrawing = false;
    let hasSignature = false;
    let paths = [];
    let currentPath = [];
    
    const pdfCtx = pdfCanvas.getContext('2d');
    const sigCtx = signatureOverlay.getContext('2d');

    // PDF URL from Django
    const pdfUrl = "{{ pdf_url|default:'' }}";

    // Load PDF
    async function loadPDF() {
        if (!pdfUrl) {
            pdfLoading.style.display = 'none';
            pdfError.style.display = 'block';
            pdfError.innerHTML = '<p>No document available. Please go back and fill in your information.</p><button onclick="history.back()">Go Back</button>';
            return;
        }

        try {
            pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
            await renderPage(1);
            pdfLoading.style.display = 'none';
            pageContainer.style.display = 'block';
            showStatus('Document loaded. Click "Start Signing" to add your signature.', true);
        } catch (error) {
            console.error('Error loading PDF:', error);
            pdfLoading.style.display = 'none';
            pdfError.style.display = 'block';
            pdfError.innerHTML = '<p>Error loading document: ' + error.message + '</p><button onclick="location.reload()">Retry</button>';
        }
    }

    // Render PDF page
    async function renderPage(pageNum) {
        if (!pdfDoc) return;

        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: currentScale });

        // Set canvas dimensions
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        signatureOverlay.width = viewport.width;
        signatureOverlay.height = viewport.height;

        // Update container size
        pageContainer.style.width = viewport.width + 'px';
        pageContainer.style.height = viewport.height + 'px';

        // Render PDF
        await page.render({
            canvasContext: pdfCtx,
            viewport: viewport
        }).promise;

        // Configure signature canvas
        sigCtx.strokeStyle = '#1a1a2e';
        sigCtx.lineWidth = 2.5;
        sigCtx.lineCap = 'round';
        sigCtx.lineJoin = 'round';

        // Redraw existing signature
        redrawSignature();
    }

    // Signature drawing functions
    function getCoordinates(e) {
        const rect = signatureOverlay.getBoundingClientRect();
        const scaleX = signatureOverlay.width / rect.width;
        const scaleY = signatureOverlay.height / rect.height;
        
        if (e.touches) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        }
        return {
            x: (e.clientX - rect.left) * scaleX,
            y: (e.clientY - rect.top) * scaleY
        };
    }

    function startDrawing(e) {
        if (!isSigningMode) return;
        e.preventDefault();
        isDrawing = true;
        
        const coords = getCoordinates(e);
        currentPath = [coords];
        sigCtx.beginPath();
        sigCtx.moveTo(coords.x, coords.y);
    }

    function draw(e) {
        if (!isDrawing || !isSigningMode) return;
        e.preventDefault();
        
        const coords = getCoordinates(e);
        sigCtx.lineTo(coords.x, coords.y);
        sigCtx.stroke();
        sigCtx.beginPath();
        sigCtx.moveTo(coords.x, coords.y);
        currentPath.push(coords);
    }

    function stopDrawing() {
        if (isDrawing && currentPath.length > 0) {
            paths.push(currentPath);
            hasSignature = true;
            updateButtonStates();
        }
        isDrawing = false;
        currentPath = [];
    }

    function redrawSignature() {
        sigCtx.clearRect(0, 0, signatureOverlay.width, signatureOverlay.height);
        sigCtx.strokeStyle = '#1a1a2e';
        sigCtx.lineWidth = 2.5;
        sigCtx.lineCap = 'round';
        sigCtx.lineJoin = 'round';

        paths.forEach(path => {
            if (path.length > 0) {
                sigCtx.beginPath();
                sigCtx.moveTo(path[0].x, path[0].y);
                path.forEach(point => sigCtx.lineTo(point.x, point.y));
                sigCtx.stroke();
            }
        });
    }

    function clearSignature() {
        sigCtx.clearRect(0, 0, signatureOverlay.width, signatureOverlay.height);
        paths = [];
        hasSignature = false;
        updateButtonStates();
        showStatus('Signature cleared.', true);
    }

    function enableSigningMode(enable) {
        isSigningMode = enable;
        signatureOverlay.classList.toggle('signing-mode', enable);
        modeIndicator.textContent = enable ? 'Signing' : 'Viewing';
        modeIndicator.classList.toggle('signing', enable);
        signModeBtn.classList.toggle('active', enable);
        
        if (enable) {
            enableSignBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854z"/>
                </svg>
                <span data-i18n="stop_signing">Stop Signing</span>
            `;
            enableSignBtn.classList.remove('primary');
            showStatus('Signing mode enabled. Draw your signature on the document.', true);
        } else {
            enableSignBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/>
                    <path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/>
                </svg>
                <span data-i18n="start_signing">Start Signing</span>
            `;
            enableSignBtn.classList.add('primary');
        }
    }

    function updateButtonStates() {
        clearSignatureBtn.disabled = !hasSignature;
        confirmSignatureBtn.disabled = !hasSignature;
    }

    function generateSignatureDataURL() {
        // Create a temporary canvas with just the signature
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        // Find signature bounds
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        paths.forEach(path => {
            path.forEach(point => {
                minX = Math.min(minX, point.x);
                minY = Math.min(minY, point.y);
                maxX = Math.max(maxX, point.x);
                maxY = Math.max(maxY, point.y);
            });
        });

        const padding = 20;
        const width = maxX - minX + padding * 2;
        const height = maxY - minY + padding * 2;

        tempCanvas.width = width;
        tempCanvas.height = height;
        tempCtx.strokeStyle = '#1a1a2e';
        tempCtx.lineWidth = 2.5;
        tempCtx.lineCap = 'round';
        tempCtx.lineJoin = 'round';

        paths.forEach(path => {
            if (path.length > 0) {
                tempCtx.beginPath();
                tempCtx.moveTo(path[0].x - minX + padding, path[0].y - minY + padding);
                path.forEach(point => {
                    tempCtx.lineTo(point.x - minX + padding, point.y - minY + padding);
                });
                tempCtx.stroke();
            }
        });

        return tempCanvas.toDataURL('image/png');
    }

    function generateSignatureSVG() {
        if (paths.length === 0) return '';

        // Find signature bounds
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        paths.forEach(path => {
            path.forEach(point => {
                minX = Math.min(minX, point.x);
                minY = Math.min(minY, point.y);
                maxX = Math.max(maxX, point.x);
                maxY = Math.max(maxY, point.y);
            });
        });

        const padding = 10;
        const width = maxX - minX + padding * 2;
        const height = maxY - minY + padding * 2;

        let pathData = '';
        paths.forEach(path => {
            if (path.length > 0) {
                pathData += `M ${(path[0].x - minX + padding).toFixed(2)} ${(path[0].y - minY + padding).toFixed(2)} `;
                for (let i = 1; i < path.length; i++) {
                    pathData += `L ${(path[i].x - minX + padding).toFixed(2)} ${(path[i].y - minY + padding).toFixed(2)} `;
                }
            }
        });

        return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
            <path d="${pathData.trim()}" fill="none" stroke="#1a1a2e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
    }

    function showStatus(message, isSuccess) {
        statusText.textContent = message;
        statusMessage.classList.toggle('success', isSuccess);
        statusMessage.classList.add('show');
        setTimeout(() => {
            statusMessage.classList.remove('show');
        }, 4000);
    }

    // Event listeners
    signatureOverlay.addEventListener('mousedown', startDrawing);
    signatureOverlay.addEventListener('mousemove', draw);
    signatureOverlay.addEventListener('mouseup', stopDrawing);
    signatureOverlay.addEventListener('mouseout', stopDrawing);
    signatureOverlay.addEventListener('touchstart', startDrawing);
    signatureOverlay.addEventListener('touchmove', draw);
    signatureOverlay.addEventListener('touchend', stopDrawing);
    signatureOverlay.addEventListener('touchcancel', stopDrawing);

    enableSignBtn.addEventListener('click', () => enableSigningMode(!isSigningMode));
    signModeBtn.addEventListener('click', () => enableSigningMode(!isSigningMode));
    clearSignatureBtn.addEventListener('click', clearSignature);

    confirmSignatureBtn.addEventListener('click', () => {
        if (hasSignature && paths.length > 0) {
            const signatureData = generateSignatureDataURL();
            const signatureSvg = generateSignatureSVG();
            
            signatureDataInput.value = signatureData;
            signatureSvgInput.value = signatureSvg;
            
            // Disable button and show loading state
            confirmSignatureBtn.disabled = true;
            confirmSignatureBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
            
            // Submit the form directly
            document.getElementById('confirmSignatureForm').submit();
        }
    });

    printDocumentBtn.addEventListener('click', () => {
        // Open print dialog
        const printUrl = "{% url 'kiosk:dw_generate_pdf' %}?format=pdf&print=1";
        const printWindow = window.open(printUrl, '_blank');
        
        // Show print confirmation modal after a short delay
        setTimeout(() => {
            printConfirmModal.classList.add('active');
        }, 1000);
    });

    // Close modals on overlay click
    signatureConfirmModal.addEventListener('click', (e) => {
        if (e.target === signatureConfirmModal) {
            signatureConfirmModal.classList.remove('active');
        }
    });

    printConfirmModal.addEventListener('click', (e) => {
        if (e.target === printConfirmModal) {
            printConfirmModal.classList.remove('active');
        }
    });

    // Zoom controls
    document.getElementById('zoomInBtn').addEventListener('click', async () => {
        if (currentScale < 3) {
            currentScale += 0.25;
            await renderPage(1);
        }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', async () => {
        if (currentScale > 0.75) {
            currentScale -= 0.25;
            await renderPage(1);
        }
    });

    // Load PDF on page load
    loadPDF();
});
</script>
{% endblock %}

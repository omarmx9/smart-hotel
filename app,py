from flask import Flask, render_template, Response, jsonify, send_from_directory
import cv2
import time
from fastmrz import FastMRZ
import os
from datetime import datetime
import logging
import json

# Setup logging
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

class PassportScannerWeb:
    def __init__(self, tessdata_path, save_dir="captured_images"):
        logger.info("Initializing PassportScannerWeb")
        logger.debug(f"Tessdata path: {tessdata_path}")
        logger.debug(f"Save directory: {save_dir}")
        
        self.fast_mrz = FastMRZ(tessdata_path=tessdata_path)
        self.save_dir = save_dir
        self.camera = None
        self.capturing = False
        self.capture_time = None
        self.latest_result = None
        
        if not os.path.exists(save_dir):
            os.makedirs(save_dir)
            logger.info(f"Created save directory: {save_dir}")
        
        logger.info("PassportScannerWeb initialized successfully")
    
    def initialize_camera(self, camera_index=3):
        """Initialize the camera"""
        logger.info(f"Attempting to initialize camera at index {camera_index}")
        if self.camera is None or not self.camera.isOpened():
            try:
                self.camera = cv2.VideoCapture(camera_index, cv2.CAP_V4L2)
                if not self.camera.isOpened():
                    logger.error(f"Failed to open camera at index {camera_index}")
                    return False
                
                self.camera.set(cv2.CAP_PROP_FOURCC, cv2.VideoWriter_fourcc('M', 'J', 'P', 'G'))
                self.camera.set(cv2.CAP_PROP_FRAME_WIDTH, 1920)
                self.camera.set(cv2.CAP_PROP_FRAME_HEIGHT, 1080)
                self.camera.set(cv2.CAP_PROP_FPS, 30)
                
                # Adjust camera settings for darker image
                self.camera.set(cv2.CAP_PROP_BRIGHTNESS, 100)  # Reduced from 130 (default is usually 128)
                self.camera.set(cv2.CAP_PROP_CONTRAST, 130)    # Keep contrast the same
                self.camera.set(cv2.CAP_PROP_EXPOSURE, -7)     # More negative = darker (-5 to -7 or -8)
                
                # Get actual values set
                actual_width = self.camera.get(cv2.CAP_PROP_FRAME_WIDTH)
                actual_height = self.camera.get(cv2.CAP_PROP_FRAME_HEIGHT)
                actual_fps = self.camera.get(cv2.CAP_PROP_FPS)
                
                logger.info(f"Camera initialized successfully")
                logger.debug(f"Resolution: {actual_width}x{actual_height}")
                logger.debug(f"FPS: {actual_fps}")
            except Exception as e:
                logger.error(f"Error initializing camera: {e}")
                return False
        else:
            logger.debug("Camera already initialized")
        
        return self.camera.isOpened()
    
    def get_frame(self):
        """Get current camera frame"""
        if self.camera is None or not self.camera.isOpened():
            logger.warning("Camera not initialized when getting frame")
            return None
        
        ret, frame = self.camera.read()
        if ret:
            # Resize for web display
            frame = cv2.resize(frame, (960, 540))
            return frame
        else:
            logger.warning("Failed to read frame from camera")
        return None
    
    def capture_and_extract(self):
        """Capture image and extract MRZ"""
        logger.info("=" * 60)
        logger.info("Starting capture and extraction process")
        
        if self.camera is None or not self.camera.isOpened():
            logger.error("Camera not initialized")
            return {"error": "Camera not initialized"}
        
        logger.info("Capturing frame...")
        ret, frame = self.camera.read()
        
        if not ret:
            logger.error("Failed to capture image from camera")
            return {"error": "Failed to capture image"}
        
        logger.info(f"Frame captured successfully - Shape: {frame.shape}")
        
        # Save image
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"passport_{timestamp}.jpg"
        filepath = os.path.join(self.save_dir, filename)
        
        logger.info(f"Saving image to: {filepath}")
        cv2.imwrite(filepath, frame)
        logger.info("Image saved successfully")
        
        # Create separate JSON folder
        json_dir = os.path.join(self.save_dir, "json_results")
        if not os.path.exists(json_dir):
            os.makedirs(json_dir)
            logger.info(f"Created JSON directory: {json_dir}")
        
        # Prepare JSON file path in separate folder
        json_filename = f"passport_{timestamp}.json"
        json_filepath = os.path.join(json_dir, json_filename)
        
        # Extract MRZ
        logger.info("Starting MRZ extraction...")
        result_data = {
            "timestamp": timestamp,
            "image_path": filepath,
            "image_filename": filename,
            "capture_time": datetime.now().isoformat(),
            "status": "pending"
        }
        
        try:
            mrz_data = self.fast_mrz.get_details(filepath)
            
            if mrz_data:
                logger.info("‚úì MRZ extraction successful!")
                logger.info("Extracted data:")
                for key, value in mrz_data.items():
                    logger.info(f"  {key}: {value}")
                
                # Update result with extracted data
                result_data["status"] = "success"
                result_data["mrz_data"] = mrz_data
                
                # Save JSON file
                with open(json_filepath, 'w', encoding='utf-8') as f:
                    json.dump(result_data, f, indent=2, ensure_ascii=False)
                
                logger.info(f"JSON saved to: {json_filepath}")
                
                self.latest_result = result_data
                logger.info("=" * 60)
                
                # Return the MRZ data directly at the top level for easier frontend access
                return {
                    "success": True, 
                    "data": mrz_data,
                    "image_path": filepath,
                    "timestamp": timestamp
                }
            else:
                logger.warning("No MRZ data found in image")
                
                result_data["status"] = "no_mrz_found"
                result_data["error"] = "No MRZ data found"
                
                # Save JSON file with error
                with open(json_filepath, 'w', encoding='utf-8') as f:
                    json.dump(result_data, f, indent=2, ensure_ascii=False)
                
                logger.info(f"JSON saved to: {json_filepath}")
                logger.info("=" * 60)
                return {"success": False, "error": "No MRZ data found"}
                
        except Exception as e:
            logger.error(f"Error during MRZ extraction: {e}")
            logger.exception("Full traceback:")
            
            result_data["status"] = "error"
            result_data["error"] = str(e)
            result_data["error_type"] = type(e).__name__
            
            # Save JSON file with error details
            with open(json_filepath, 'w', encoding='utf-8') as f:
                json.dump(result_data, f, indent=2, ensure_ascii=False)
            
            logger.info(f"JSON saved to: {json_filepath}")
            logger.info("=" * 60)
            return {"success": False, "error": str(e)}
        def release_camera(self):
            """Release camera resources"""
            logger.info("Releasing camera")
            if self.camera is not None:
                self.camera.release()
                self.camera = None
                logger.info("Camera released successfully")

# Initialize scanner
logger.info("Starting application initialization")
scanner = PassportScannerWeb(
    tessdata_path="/media/oxa/SpaceRocket/SpaceRocket/Work/kioskC/",
    save_dir="/media/oxa/SpaceRocket/SpaceRocket/Work/kioskC/captured_passports"
)

# Serve static files (HTML, CSS, JS) from 'web' folder
@app.route('/')
def index():
    """Serve index.html"""
    logger.info("Serving index.html")
    return send_from_directory('web', 'index.html')

@app.route('/<path:filename>')
def serve_static(filename):
    """Serve CSS and JS files"""
    logger.debug(f"Serving static file: {filename}")
    return send_from_directory('web', filename)

@app.route('/video_feed')
def video_feed():
    """Video streaming route"""
    logger.info("Video feed requested")
    
    def generate():
        logger.info("Starting video stream generator")
        scanner.initialize_camera(camera_index=3)
        
        frame_count = 0
        while True:
            frame = scanner.get_frame()
            
            if frame is not None:
                # Encode frame as JPEG
                ret, buffer = cv2.imencode('.jpg', frame)
                frame_bytes = buffer.tobytes()
                
                frame_count += 1
                if frame_count % 30 == 0:  # Log every 30 frames (~1 second at 30fps)
                    logger.debug(f"Video stream: {frame_count} frames sent")
                
                yield (b'--frame\r\n'
                       b'Content-Type: image/jpeg\r\n\r\n' + frame_bytes + b'\r\n')
            else:
                time.sleep(0.1)
    
    return Response(generate(), mimetype='multipart/x-mixed-replace; boundary=frame')

@app.route('/capture', methods=['POST'])
def capture():
    """Capture and process passport"""
    logger.info("Capture request received from client")
    result = scanner.capture_and_extract()
    logger.info(f"Sending response to client: {result.get('success', False)}")
    return jsonify(result)

@app.route('/start_camera', methods=['POST'])
def start_camera():
    """Initialize camera"""
    logger.info("Start camera request received")
    success = scanner.initialize_camera(camera_index=3)
    logger.info(f"Camera start result: {success}")
    return jsonify({"success": success})

@app.route('/stop_camera', methods=['POST'])
def stop_camera():
    """Stop camera"""
    logger.info("Stop camera request received")
    scanner.release_camera()
    return jsonify({"success": True})

if __name__ == '__main__':
    print("\n" + "=" * 60)
    print("PASSPORT SCANNER WEB SERVER")
    print("=" * 60)
    print("\nüìÅ Project Structure:")
    print("  web/index.html")
    print("  web/style.css")
    print("  web/main.js")
    print("\nüåê Server Info:")
    print("  URL: http://localhost:5000")
    print("  Debug Mode: ON")
    print("  Logging Level: DEBUG")
    print("\nüé• Camera:")
    print("  Device: /dev/video3 (HD Pro Webcam C920)")
    print("  Resolution: 1920x1080")
    print("\n" + "=" * 60)
    print("Server starting... Press Ctrl+C to stop")
    print("=" * 60 + "\n")
    
    logger.info("Flask server starting")
    app.run(host='0.0.0.0', port=5000, debug=True, threaded=True)
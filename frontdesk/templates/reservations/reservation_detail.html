{% extends "base.html" %}

{% block title %}{{ reservation.reservation_number }}{% endblock %}
{% block page_title %}Reservation Details{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Main Info -->
    <div class="col-lg-8">
        <div class="table-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-calendar-check me-2"></i>
                    {{ reservation.reservation_number }}
                    <span class="badge-status badge-{{ reservation.status|slugify }} ms-2">{{ reservation.get_status_display }}</span>
                </span>
                <div>
                    {% if reservation.status in 'pending,confirmed' %}
                    <a href="{% url 'reservations:check_in' reservation.pk %}" class="btn btn-success btn-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i> Check In
                    </a>
                    <a href="{% url 'reservations:reservation_edit' reservation.pk %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </a>
                    {% elif reservation.status == 'checked_in' %}
                    <a href="{% url 'reservations:check_out' reservation.pk %}" class="btn btn-warning btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i> Check Out
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Stay Details</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted" style="width: 140px;">Check-In:</td>
                                <td><strong>{{ reservation.check_in_date }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Check-Out:</td>
                                <td><strong>{{ reservation.check_out_date }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Nights:</td>
                                <td>{{ reservation.nights }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Room:</td>
                                <td>
                                    {% if reservation.room %}
                                    <a href="{% url 'reservations:room_detail' reservation.room.pk %}">
                                        {{ reservation.room.room_number }} ({{ reservation.room.get_room_type_display }})
                                    </a>
                                    {% else %}
                                    <span class="text-warning">Not Assigned</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Guests:</td>
                                <td>{{ reservation.adults }} Adult(s){% if reservation.children %}, {{ reservation.children }} Child(ren){% endif %}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Payment</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted" style="width: 140px;">Rate/Night:</td>
                                <td>${{ reservation.rate_per_night }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Total:</td>
                                <td><strong>${{ reservation.total_amount }}</strong></td>
                            </tr>
                            <tr>
                                <td class="text-muted">Paid:</td>
                                <td class="text-success">${{ reservation.amount_paid }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Balance:</td>
                                <td class="{% if reservation.balance_due > 0 %}text-danger fw-bold{% else %}text-success{% endif %}">
                                    ${{ reservation.balance_due }}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Status:</td>
                                <td>
                                    <span class="badge-status badge-{% if reservation.payment_status == 'paid' %}checked-in{% elif reservation.payment_status == 'pending' %}pending{% else %}confirmed{% endif %}">
                                        {{ reservation.get_payment_status_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                {% if reservation.special_requests %}
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Special Requests</h6>
                    <p class="mb-0 p-3 bg-light rounded">{{ reservation.special_requests }}</p>
                </div>
                {% endif %}
                
                {% if reservation.access_card_issued %}
                <div class="mt-3">
                    <span class="badge bg-success">
                        <i class="bi bi-credit-card me-1"></i> Access Card: {{ reservation.access_card_number }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Notes -->
        <div class="table-card">
            <div class="card-header">
                <i class="bi bi-chat-left-text me-2"></i> Notes
            </div>
            <div class="card-body p-4">
                <form method="post" action="{% url 'reservations:reservation_add_note' reservation.pk %}" class="mb-4">
                    {% csrf_token %}
                    <div class="input-group">
                        <textarea name="note" class="form-control" rows="2" placeholder="Add a note..."></textarea>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </form>
                
                {% for note in notes %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>{{ note.created_by.get_full_name }}</strong>
                        <small class="text-muted">{{ note.created_at }}</small>
                    </div>
                    <p class="mb-0 mt-2">{{ note.note }}</p>
                </div>
                {% empty %}
                <p class="text-muted text-center">No notes yet</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Guest Info -->
        <div class="table-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-person me-2"></i> Guest</span>
                <a href="{% url 'reservations:guest_detail' reservation.guest.pk %}" class="btn btn-sm btn-outline-primary">View Profile</a>
            </div>
            <div class="card-body p-4">
                <h5 class="mb-1">
                    {{ reservation.guest.full_name }}
                    {% if reservation.guest.vip %}<span class="vip-badge ms-2">VIP</span>{% endif %}
                </h5>
                
                {% if reservation.guest.email %}
                <p class="mb-1"><i class="bi bi-envelope me-2 text-muted"></i>{{ reservation.guest.email }}</p>
                {% endif %}
                
                {% if reservation.guest.phone_number %}
                <p class="mb-1"><i class="bi bi-telephone me-2 text-muted"></i>{{ reservation.guest.phone_number }}</p>
                {% endif %}
                
                {% if reservation.guest.passport_number %}
                <p class="mb-1"><i class="bi bi-passport me-2 text-muted"></i>{{ reservation.guest.passport_number }}</p>
                {% endif %}
                
                {% if reservation.guest.nationality %}
                <p class="mb-0"><i class="bi bi-globe me-2 text-muted"></i>{{ reservation.guest.nationality }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Documents -->
        <div class="table-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-file-earmark me-2"></i> Documents</span>
                <a href="{% url 'documents:upload' reservation.guest.pk %}" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-upload"></i>
                </a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for doc in documents %}
                    <a href="{% url 'documents:detail' doc.pk %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-file-earmark-text me-2"></i>
                            {{ doc.get_document_type_display }}
                        </div>
                        {% if doc.verified %}
                        <span class="badge bg-success">Verified</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Unverified</span>
                        {% endif %}
                    </a>
                    {% empty %}
                    <div class="list-group-item text-center text-muted">
                        No documents uploaded
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="table-card">
            <div class="card-header">
                <i class="bi bi-gear me-2"></i> Actions
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% if reservation.status in 'pending,confirmed' %}
                    <a href="{% url 'reservations:check_in' reservation.pk %}" class="list-group-item list-group-item-action text-success">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Check In Guest
                    </a>
                    <button onclick="cancelReservation({{ reservation.pk }})" class="list-group-item list-group-item-action text-danger">
                        <i class="bi bi-x-circle me-2"></i> Cancel Reservation
                    </button>
                    {% elif reservation.status == 'checked_in' %}
                    <a href="{% url 'reservations:check_out' reservation.pk %}" class="list-group-item list-group-item-action text-warning">
                        <i class="bi bi-box-arrow-right me-2"></i> Check Out Guest
                    </a>
                    {% endif %}
                    <a href="{% url 'documents:sync_from_kiosk' reservation.guest.pk %}" class="list-group-item list-group-item-action">
                        <i class="bi bi-arrow-repeat me-2"></i> Sync from Kiosk
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function cancelReservation(pk) {
    if (confirm('Are you sure you want to cancel this reservation?')) {
        fetch(`/reservations/${pk}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => response.json()).then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to cancel reservation');
            }
        });
    }
}
</script>
{% endblock %}

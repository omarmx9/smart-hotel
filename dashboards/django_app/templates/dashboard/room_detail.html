{% extends 'base.html' %}

{% block title %}Room {{ room.room_number }} - Smart Hotel{% endblock %}

{% block extra_css %}
<style>
    .room-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--color-text-secondary);
        text-decoration: none;
        font-size: 14px;
        transition: color 0.2s;
    }

    .back-link:hover { color: var(--color-text-primary); }
    .back-link svg { width: 16px; height: 16px; }

    .room-title {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .room-badge {
        padding: 4px 12px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 20px;
        text-transform: uppercase;
    }

    .room-badge.occupied { background-color: rgba(66, 133, 244, 0.15); color: var(--color-accent-blue); }
    .room-badge.vacant { background-color: rgba(52, 168, 83, 0.15); color: var(--color-accent-green); }
    .room-badge.maintenance { background-color: rgba(249, 171, 0, 0.15); color: var(--color-accent-orange); }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 20px;
    }

    .card {
        background-color: var(--color-bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        overflow: hidden;
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--color-border);
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 500;
        color: var(--color-text-secondary);
    }

    .card-title svg { width: 18px; height: 18px; }

    .card-body { padding: 20px; }

    .metric-value {
        font-size: 48px;
        font-weight: 700;
        letter-spacing: -0.03em;
        line-height: 1;
    }

    .metric-unit {
        font-size: 20px;
        font-weight: 400;
        color: var(--color-text-secondary);
        margin-left: 4px;
    }

    .metric-label {
        font-size: 13px;
        color: var(--color-text-muted);
        margin-top: 8px;
    }

    .temp-card { grid-column: span 3; }
    .humidity-card { grid-column: span 3; }
    .luminosity-card { grid-column: span 3; }
    .gas-card { grid-column: span 3; }
    .climate-card { grid-column: span 6; }
    .light-card { grid-column: span 6; }
    .chart-card { grid-column: span 12; }

    .alert-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 20px;
    }

    .alert-badge.normal { background-color: rgba(52, 168, 83, 0.15); color: var(--color-accent-green); }
    .alert-badge.warning { background-color: rgba(249, 171, 0, 0.15); color: var(--color-accent-orange); animation: pulse 1.5s infinite; }
    .alert-badge.danger { background-color: rgba(234, 67, 53, 0.15); color: var(--color-accent-red); animation: pulse 1s infinite; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .gas-bar-container {
        margin-top: 16px;
    }

    .gas-bar {
        width: 100%;
        height: 12px;
        background-color: var(--color-bg-elevated);
        border-radius: 6px;
        overflow: hidden;
    }

    .gas-bar-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s, background-color 0.3s;
    }

    .gas-bar-fill.safe { background: linear-gradient(90deg, var(--color-accent-green), #45b058); }
    .gas-bar-fill.warning { background: linear-gradient(90deg, var(--color-accent-orange), #ffbf00); }
    .gas-bar-fill.danger { background: linear-gradient(90deg, var(--color-accent-red), #ff5252); }

    .gas-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 11px;
        color: var(--color-text-muted);
    }

    .control-row {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 16px 0;
        border-bottom: 1px solid var(--color-border);
    }

    .control-row:last-child { border-bottom: none; }

    .control-label {
        flex: 1;
        font-size: 14px;
        color: var(--color-text-secondary);
    }

    .control-slider {
        flex: 2;
        height: 8px;
        border-radius: 4px;
        background: var(--color-bg-elevated);
        appearance: none;
        outline: none;
        cursor: pointer;
    }

    .control-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-accent-cyan);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.4);
    }

    .control-slider:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .control-value {
        min-width: 70px;
        font-size: 16px;
        font-weight: 600;
        color: var(--color-accent-cyan);
        text-align: right;
    }

    .chart-wrapper {
        height: 300px;
    }

    .no-control-notice {
        padding: 16px;
        background-color: var(--color-bg-elevated);
        border-radius: var(--radius-md);
        color: var(--color-text-muted);
        font-size: 13px;
        text-align: center;
    }

    @media (max-width: 1200px) {
        .temp-card, .humidity-card, .luminosity-card, .gas-card { grid-column: span 6; }
        .climate-card, .light-card { grid-column: span 6; }
    }

    @media (max-width: 992px) {
        .temp-card, .humidity-card, .luminosity-card, .gas-card { grid-column: span 6; }
        .climate-card, .light-card { grid-column: span 12; }
    }

    @media (max-width: 768px) {
        .temp-card, .humidity-card, .luminosity-card, .gas-card { grid-column: span 12; }
    }

    /* Mode toggle buttons */
    .mode-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .mode-btn {
        flex: 1;
        padding: 10px 16px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background-color: var(--color-bg-elevated);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .mode-btn:hover {
        background-color: var(--color-bg-card);
        border-color: var(--color-text-muted);
    }

    .mode-btn.active {
        background-color: var(--color-accent-cyan);
        border-color: var(--color-accent-cyan);
        color: #000;
    }

    .mode-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Light control buttons */
    .light-toggle {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .light-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        background-color: var(--color-bg-elevated);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .light-btn svg {
        width: 28px;
        height: 28px;
        margin-bottom: 6px;
    }

    .light-btn span {
        font-size: 11px;
        font-weight: 500;
    }

    .light-btn:hover {
        background-color: var(--color-bg-card);
        border-color: var(--color-text-muted);
    }

    .light-btn.active {
        background-color: rgba(249, 171, 0, 0.15);
        border-color: var(--color-accent-orange);
        color: var(--color-accent-orange);
    }

    .light-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Fan speed control */
    .fan-speed-toggle {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .fan-btn {
        flex: 1;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background-color: var(--color-bg-elevated);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .fan-btn:hover {
        background-color: var(--color-bg-card);
    }

    .fan-btn.active {
        background-color: var(--color-accent-blue);
        border-color: var(--color-accent-blue);
        color: #fff;
    }

    .fan-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Conditional sections */
    .control-section {
        padding: 16px 0;
        border-bottom: 1px solid var(--color-border);
    }

    .control-section:last-child {
        border-bottom: none;
    }

    .control-section.hidden {
        display: none;
    }

    .control-section-label {
        font-size: 12px;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }

    .current-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background-color: var(--color-bg-elevated);
        border-radius: var(--radius-md);
        margin-top: 16px;
    }

    .current-status-label {
        font-size: 13px;
        color: var(--color-text-secondary);
    }

    .current-status-value {
        font-weight: 600;
        color: var(--color-accent-cyan);
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
{% if access_denied %}
<div class="empty-state">
    <h2>Access Denied</h2>
    <p>You do not have permission to view this room.</p>
</div>
{% else %}
<div class="room-header-bar">
    {% if not user.is_guest %}
    <a href="{% url 'dashboard:index' %}" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        Back to Dashboard
    </a>
    {% else %}
    <span></span>
    {% endif %}
    <div class="room-title">
        <h1 class="header-title">Room {{ room.room_number }}</h1>
        <span class="room-badge {{ room.status }}">{{ room.get_status_display }}</span>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Temperature Card -->
    <div class="card temp-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
                Temperature
            </div>
            <span class="alert-badge {{ room.temperature_alert }}" id="temp-alert">
                {% if room.temperature_alert == 'danger' %}High{% elif room.temperature_alert == 'warning' %}Warning{% else %}Normal{% endif %}
            </span>
        </div>
        <div class="card-body">
            <div class="metric-value">
                <span id="temperature">{{ room.temperature|floatformat:1 }}</span>
                <span class="metric-unit">°C</span>
            </div>
            <div class="metric-label">Current reading</div>
        </div>
    </div>

    <!-- Humidity Card -->
    <div class="card humidity-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                Humidity
            </div>
        </div>
        <div class="card-body">
            <div class="metric-value">
                <span id="humidity">{{ room.humidity|floatformat:0 }}</span>
                <span class="metric-unit">%</span>
            </div>
            <div class="metric-label">Relative humidity</div>
        </div>
    </div>

    <!-- Luminosity Sensor Card -->
    <div class="card luminosity-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                Luminosity
            </div>
        </div>
        <div class="card-body">
            <div class="metric-value">
                <span id="luminosity-sensor">{{ room.luminosity }}</span>
                <span class="metric-unit">lux</span>
            </div>
            <div class="metric-label">Light intensity</div>
        </div>
    </div>

    <!-- Gas Card -->
    <div class="card gas-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/></svg>
                Gas Detection
            </div>
            <span class="alert-badge {{ room.gas_alert }}" id="gas-alert">
                {% if room.gas_alert == 'danger' %}Danger{% elif room.gas_alert == 'warning' %}Warning{% else %}Safe{% endif %}
            </span>
        </div>
        <div class="card-body">
            <div class="metric-value" style="font-size: 36px;">
                <span id="gas-value">{{ room.gas_level }}</span>
                <span class="metric-unit">ppm</span>
            </div>
            <div class="gas-bar-container">
                <div class="gas-bar">
                    <div class="gas-bar-fill {% if room.gas_alert == 'danger' %}danger{% elif room.gas_alert == 'warning' %}warning{% else %}safe{% endif %}" id="gas-bar" style="width: {{ room.gas_level|divisibleby:10 }}%;"></div>
                </div>
                <div class="gas-labels">
                    <span>0 ppm</span>
                    <span>Safe: &lt;400</span>
                    <span>1000 ppm</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Climate Control Card -->
    <div class="card climate-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg>
                Climate Control
            </div>
            <span class="alert-badge" id="hvac-status" style="{% if room.heating_status %}background-color: rgba(249, 171, 0, 0.15); color: var(--color-accent-orange);{% else %}background-color: rgba(52, 168, 83, 0.15); color: var(--color-accent-green);{% endif %}">
                {% if room.heating_status %}Heating{% else %}Standby{% endif %}
            </span>
        </div>
        <div class="card-body">
            {% if can_control %}
            <!-- Mode Selection -->
            <div class="control-section">
                <div class="control-section-label">Mode</div>
                <div class="mode-toggle">
                    <button type="button" class="mode-btn {% if room.climate_mode == 'auto' %}active{% endif %}" data-mode="auto" id="mode-auto">Auto</button>
                    <button type="button" class="mode-btn {% if room.climate_mode == 'manual' %}active{% endif %}" data-mode="manual" id="mode-manual">Manual</button>
                    <button type="button" class="mode-btn {% if room.climate_mode == 'off' %}active{% endif %}" data-mode="off" id="mode-off">Off</button>
                </div>
            </div>

            <!-- Target Temperature (visible only in auto mode) -->
            <div class="control-section {% if room.climate_mode != 'auto' %}hidden{% endif %}" id="temp-control-section">
                <div class="control-section-label">Target Temperature</div>
                <div class="control-row" style="border-bottom: none; padding: 0;">
                    <input type="range" min="16" max="32" value="{{ room.target_temperature|floatformat:0 }}" class="control-slider" id="temp-slider">
                    <span class="control-value" id="target-temp">{{ room.target_temperature|floatformat:1 }}°C</span>
                </div>
            </div>

            <!-- Fan Speed (visible only in manual mode) -->
            <div class="control-section {% if room.climate_mode != 'manual' %}hidden{% endif %}" id="fan-control-section">
                <div class="control-section-label">Fan Speed</div>
                <div class="fan-speed-toggle">
                    <button type="button" class="fan-btn {% if room.fan_speed == 'low' %}active{% endif %}" data-speed="low">Low</button>
                    <button type="button" class="fan-btn {% if room.fan_speed == 'medium' %}active{% endif %}" data-speed="medium">Medium</button>
                    <button type="button" class="fan-btn {% if room.fan_speed == 'high' %}active{% endif %}" data-speed="high">High</button>
                </div>
            </div>

            <div class="current-status">
                <span class="current-status-label">Current Temperature</span>
                <span class="current-status-value"><span id="current-temp-display">{{ room.temperature|floatformat:1 }}</span>°C</span>
            </div>
            {% else %}
            <div class="no-control-notice">
                <p>You have view-only access. Climate control is disabled.</p>
            </div>
            <div class="control-row">
                <span class="control-label">Mode</span>
                <span class="control-value">{{ room.get_climate_mode_display }}</span>
            </div>
            <div class="control-row">
                <span class="control-label">Target Temperature</span>
                <span class="control-value">{{ room.target_temperature|floatformat:1 }}°C</span>
            </div>
            <div class="control-row">
                <span class="control-label">HVAC Status</span>
                <span class="control-value">{% if room.heating_status %}ON{% else %}OFF{% endif %}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Light Control Card -->
    <div class="card light-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>
                Light Control
            </div>
            <span class="alert-badge" id="light-status" style="background-color: rgba(249, 171, 0, 0.15); color: var(--color-accent-orange);">
                <span id="light-status-text">{{ room.luminosity_display }}</span>
            </span>
        </div>
        <div class="card-body">
            {% if can_control %}
            <div class="control-section" style="border-bottom: none; padding-top: 8px;">
                <div class="light-toggle">
                    <button type="button" class="light-btn light-mode-btn {% if room.light_mode == 'auto' %}active{% endif %}" data-mode="auto" id="light-auto">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/><circle cx="12" cy="12" r="4"/><path d="M12 8a4 4 0 0 1 0 8" fill="currentColor" opacity="0.3"/></svg>
                        <span>Auto</span>
                    </button>
                    <button type="button" class="light-btn light-level-btn {% if room.light_mode == 'manual' and room.luminosity == 0 %}active{% endif %}" data-level="0" id="light-0" {% if room.light_mode == 'auto' %}disabled{% endif %}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" opacity="0.3"/><line x1="12" y1="1" x2="12" y2="3" opacity="0.3"/><line x1="12" y1="21" x2="12" y2="23" opacity="0.3"/></svg>
                        <span>Off</span>
                    </button>
                    <button type="button" class="light-btn light-level-btn {% if room.light_mode == 'manual' and room.luminosity == 1 %}active{% endif %}" data-level="1" id="light-1" {% if room.light_mode == 'auto' %}disabled{% endif %}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/></svg>
                        <span>1 Light</span>
                    </button>
                    <button type="button" class="light-btn light-level-btn {% if room.light_mode == 'manual' and room.luminosity == 2 %}active{% endif %}" data-level="2" id="light-2" {% if room.light_mode == 'auto' %}disabled{% endif %}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="currentColor"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>
                        <span>2 Lights</span>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="no-control-notice">
                <p>You have view-only access. Light control is disabled.</p>
            </div>
            <div class="control-row" style="justify-content: center;">
                <span class="control-value" style="font-size: 24px;">{{ room.luminosity_display }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Chart Card -->
    <div class="card chart-card">
        <div class="card-header">
            <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                Sensor History
            </div>
        </div>
        <div class="card-body">
            <div class="chart-wrapper">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    const roomId = {{ room.id }};
    const canControl = {{ can_control|yesno:"true,false" }};
    const csrfToken = '{{ csrf_token }}';
    let ws = null;
    let currentClimateMode = '{{ room.climate_mode }}';
    let currentLuminosity = {{ room.luminosity }};
    let currentLightMode = '{{ room.light_mode }}';
    let currentFanSpeed = '{{ room.fan_speed }}';

    // Chart setup
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Temperature (°C)',
                    data: [],
                    borderColor: '#ea4335',
                    backgroundColor: 'rgba(234, 67, 53, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: '#4285f4',
                    backgroundColor: 'rgba(66, 133, 244, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#9aa0a6', font: { size: 12 } }
                }
            },
            scales: {
                y: {
                    ticks: { color: '#5f6368' },
                    grid: { color: 'rgba(60, 67, 84, 0.5)' }
                },
                x: {
                    ticks: { color: '#5f6368', maxRotation: 0 },
                    grid: { display: false }
                }
            }
        }
    });

    function updateUI(data) {
        document.getElementById('temperature').textContent = data.temperature.toFixed(1);
        document.getElementById('humidity').textContent = Math.round(data.humidity);
        document.getElementById('gas-value').textContent = data.gas_level;
        
        // Update luminosity sensor reading
        const luminositySensor = document.getElementById('luminosity-sensor');
        if (luminositySensor && data.luminosity !== undefined) {
            luminositySensor.textContent = data.luminosity;
        }
        
        // Update current temp display in climate card
        const currentTempDisplay = document.getElementById('current-temp-display');
        if (currentTempDisplay) {
            currentTempDisplay.textContent = data.temperature.toFixed(1);
        }

        // Update luminosity/light status
        if (data.luminosity !== undefined) {
            currentLuminosity = data.luminosity;
            updateLightButtons(data.luminosity);
            const lightStatusText = document.getElementById('light-status-text');
            if (lightStatusText) {
                const labels = ['Off', '1 Light', '2 Lights'];
                lightStatusText.textContent = labels[data.luminosity] || 'Off';
            }
        }

        // Update climate mode if received from physical controls
        if (data.climate_mode !== undefined && data.climate_mode !== currentClimateMode) {
            currentClimateMode = data.climate_mode;
            updateModeButtons(data.climate_mode);
            updateControlVisibility(data.climate_mode);
        }

        // Update fan speed if received from physical controls
        if (data.fan_speed !== undefined && data.fan_speed !== currentFanSpeed) {
            currentFanSpeed = data.fan_speed;
            updateFanButtons(data.fan_speed);
        }

        // Update alerts
        const tempAlert = document.getElementById('temp-alert');
        tempAlert.className = 'alert-badge ' + data.temperature_alert;
        tempAlert.textContent = data.temperature_alert === 'danger' ? 'High' : data.temperature_alert === 'warning' ? 'Warning' : 'Normal';

        const gasAlert = document.getElementById('gas-alert');
        gasAlert.className = 'alert-badge ' + data.gas_alert;
        gasAlert.textContent = data.gas_alert === 'danger' ? 'Danger' : data.gas_alert === 'warning' ? 'Warning' : 'Safe';

        // Update gas bar
        const gasBar = document.getElementById('gas-bar');
        const gasPercent = Math.min((data.gas_level / 1000) * 100, 100);
        gasBar.style.width = gasPercent + '%';
        gasBar.className = 'gas-bar-fill ' + (data.gas_alert === 'danger' ? 'danger' : data.gas_alert === 'warning' ? 'warning' : 'safe');

        // Update chart
        if (data.history && data.history.length > 0) {
            chart.data.labels = data.history.map(h => h.timestamp.split(' ')[1]);
            chart.data.datasets[0].data = data.history.map(h => h.temperature);
            chart.data.datasets[1].data = data.history.map(h => h.humidity);
            chart.update('none');
        }
    }

    // Helper functions for updating button states
    function updateModeButtons(mode) {
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
    }

    function updateFanButtons(speed) {
        document.querySelectorAll('.fan-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.speed === speed);
        });
    }

    function updateLightButtons(level) {
        document.querySelectorAll('.light-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.level) === level);
        });
    }

    function updateControlVisibility(mode) {
        const tempSection = document.getElementById('temp-control-section');
        const fanSection = document.getElementById('fan-control-section');
        
        if (tempSection) {
            tempSection.classList.toggle('hidden', mode !== 'auto');
        }
        if (fanSection) {
            fanSection.classList.toggle('hidden', mode !== 'manual');
        }
    }

    // WebSocket connection
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    function connectWS() {
        ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/room/${roomId}/`);
        ws.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.room) updateUI(data.room);
        };
        ws.onclose = function() { setTimeout(connectWS, 3000); };
    }
    connectWS();

    // Temperature control
    if (canControl) {
        const slider = document.getElementById('temp-slider');
        const targetDisplay = document.getElementById('target-temp');

        if (slider) {
            slider.addEventListener('input', function() {
                targetDisplay.textContent = this.value + '°C';
            });

            slider.addEventListener('change', function() {
                const target = parseFloat(this.value);
                fetch(`/api/room/${roomId}/set_target/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ target: target })
                });
            });
        }

        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const mode = this.dataset.mode;
                currentClimateMode = mode;
                updateModeButtons(mode);
                updateControlVisibility(mode);
                
                fetch(`/api/room/${roomId}/set_climate_mode/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ mode: mode })
                });
            });
        });

        // Fan speed buttons
        document.querySelectorAll('.fan-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const speed = this.dataset.speed;
                currentFanSpeed = speed;
                updateFanButtons(speed);
                
                fetch(`/api/room/${roomId}/set_fan_speed/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ speed: speed })
                });
            });
        });

        // Light mode button (Auto)
        document.querySelectorAll('.light-mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentLightMode = 'auto';
                
                // Update button states
                document.querySelectorAll('.light-mode-btn').forEach(b => b.classList.add('active'));
                document.querySelectorAll('.light-level-btn').forEach(b => {
                    b.classList.remove('active');
                    b.disabled = true;
                });
                
                const lightStatusText = document.getElementById('light-status-text');
                if (lightStatusText) {
                    lightStatusText.textContent = 'Auto';
                }
                
                fetch(`/api/room/${roomId}/set_light_mode/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ mode: 'auto' })
                });
            });
        });

        // Light level buttons (Manual control)
        document.querySelectorAll('.light-level-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.disabled) return;
                
                const level = parseInt(this.dataset.level);
                currentLuminosity = level;
                currentLightMode = 'manual';
                
                // Update button states
                document.querySelectorAll('.light-mode-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.light-level-btn').forEach(b => {
                    b.classList.remove('active');
                    b.disabled = false;
                });
                this.classList.add('active');
                
                const labels = ['Off', '1 Light', '2 Lights'];
                const lightStatusText = document.getElementById('light-status-text');
                if (lightStatusText) {
                    lightStatusText.textContent = labels[level];
                }
                
                // First set mode to manual, then set luminosity
                fetch(`/api/room/${roomId}/set_light_mode/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ mode: 'manual' })
                }).then(() => {
                    fetch(`/api/room/${roomId}/set_luminosity/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ luminosity: level })
                    });
                });
            });
        });
    }

    // Poll for updates
    setInterval(() => {
        fetch(`/api/room/${roomId}/`)
            .then(r => r.json())
            .then(updateUI)
            .catch(() => {});
    }, 5000);
</script>
{% endblock %}

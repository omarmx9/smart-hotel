# syntax=docker/dockerfile:1
# Smart Hotel Cloud Infrastructure
# All configuration via .env file - run ./generate-env.sh to create one
#
# Usage:
#   Production: docker compose up -d
#   Development: docker compose -f docker-compose.yml -f docker-compose-dev.yml up

x-python-base: &python-base
  image: python:3.11-slim-bookworm

services:
  # ...existing code...
  # ============================================================================
  # CORE DATA SERVICES
  # ============================================================================

  influxdb:
    image: docker.io/influxdb:2-alpine
    container_name: influxdb
    ports:
      - "${INFLUX_PORT:-8086}:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUX_ADMIN_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_ADMIN_PASSWORD:-adminpass}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUX_ORG:-smarthotel}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUX_BUCKET:-sensors}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUX_RETENTION:-0}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN}
    volumes:
      - influxdb-data:/var/lib/influxdb2:rw
      - influxdb-config:/etc/influxdb2:rw
      - ./config/influxdb/init-telegraf.sh:/docker-entrypoint-initdb.d/init-telegraf.sh:ro
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: docker.io/postgres:16-alpine
    container_name: postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-smarthotel}
      - POSTGRES_USER=${POSTGRES_USER:-smarthotel}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data:rw
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-smarthotel}"]
      interval: 30s
      timeout: 10s
      retries: 3

  dashboard:
    <<: *python-base
    container_name: dashboard
    ports:
      - "${DASHBOARD_PORT:-8001}:8000"
    environment:
      # Database
      - DATABASE_URL=postgres://${POSTGRES_USER:-smarthotel}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-smarthotel}
      - POSTGRES_DB=${POSTGRES_DB:-smarthotel}
      - POSTGRES_USER=${POSTGRES_USER:-smarthotel}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      # InfluxDB
      - INFLUX_URL=http://influxdb:8086
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG:-smarthotel}
      - INFLUX_BUCKET=${INFLUX_BUCKET:-sensors}
      # Django
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-False}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      # MQTT
      - MQTT_BROKER=mosquitto
      - MQTT_PORT=1883
      # Session settings (7 days default for hotel guests)
      - SESSION_COOKIE_AGE=${SESSION_COOKIE_AGE:-604800}
      # Telegram (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      # Node-RED SMS Gateway
      - NODERED_URL=http://nodered:1880
      # Kiosk API token for guest account integration
      - KIOSK_API_TOKEN=${KIOSK_API_TOKEN:-}
    working_dir: /app
    volumes:
      - ../dashboards/django_app:/app:rw
      - ~/.cache/pip:/root/.cache/pip:rw
    command: >
      sh -c "
        apt-get update && apt-get install -y --no-install-recommends libpq-dev &&
        pip install -r requirements.txt daphne &&
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput --clear &&
        daphne -b 0.0.0.0 -p 8000 smart_hotel.asgi:application
      "
    depends_on:
      - influxdb
      - postgres
      - mosquitto
      - nodered
    restart: unless-stopped
    networks:
      - default

  grafana:
    image: docker.io/grafana/grafana:latest
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
      # Session settings
      - GF_SESSION_COOKIE_MAX_AGE=${SESSION_COOKIE_AGE:-604800}
      # InfluxDB datasource
      - INFLUX_TOKEN=${INFLUX_TOKEN}
    volumes:
      - grafana-data:/var/lib/grafana:rw
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-logs:/var/log/grafana:rw
    depends_on:
      - influxdb
      - telegraf
    restart: unless-stopped
    networks:
      - default

  telegraf:
    image: docker.io/telegraf:alpine
    container_name: telegraf
    depends_on:
      influxdb:
        condition: service_healthy
      mosquitto:
        condition: service_started
    volumes:
      - ./config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    environment:
      - INFLUX_URL=http://influxdb:8086
      - INFLUX_TOKEN=${INFLUX_TOKEN}
      - INFLUX_ORG=${INFLUX_ORG:-smarthotel}
      - INFLUX_BUCKET=${INFLUX_BUCKET:-sensors}
      - MQTT_USER=${MQTT_USER:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
    restart: unless-stopped
    cap_add:
      - CAP_NET_RAW
    networks:
      - default

  mosquitto:
    image: docker.io/eclipse-mosquitto:latest
    container_name: mosquitto
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
      - "${MQTT_TLS_PORT:-8883}:8883"
    volumes:
      - ./config/mosquitto:/mosquitto/config:rw
      - mosquitto-data:/mosquitto/data:rw
      - mosquitto-logs:/mosquitto/log:rw
    restart: unless-stopped
    networks:
      - default

  # ============================================================================
  # NODE-RED - Headless Notification Gateway (Telegram + SMS)
  # ============================================================================

  nodered:
    image: docker.io/nodered/node-red:latest
    container_name: nodered
    environment:
      - TZ=${TIMEZONE:-UTC}
      # Telegram Bot Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      # Twilio SMS Configuration
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER:-}
      # MQTT Authentication (optional)
      - MQTT_USER=${MQTT_USER:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      # Node-RED credential encryption
      - NODE_RED_CREDENTIAL_SECRET=${NODERED_CREDENTIAL_SECRET}
    volumes:
      - nodered-data:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
      - ./config/nodered/flows.json:/data/flows.json:ro
    # No ports exposed - Node-RED is headless (internal only)
    depends_on:
      - mosquitto
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:1880/api/ || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # KIOSK SERVICES
  # ============================================================================

  # Main Kiosk Web Application (Django)
  kiosk:
    <<: *python-base
    container_name: kiosk
    ports:
      - "${KIOSK_PORT:-8002}:8000"
    environment:
      DEBUG: '${KIOSK_DEBUG:-0}'
      SECRET_KEY: '${KIOSK_SECRET_KEY}'
      ALLOWED_HOSTS: '${KIOSK_ALLOWED_HOSTS:-*}'
      # MRZ backend service connection
      MRZ_SERVICE_URL: 'http://mrz-backend:5000'
      # Dashboard API for guest account creation
      DASHBOARD_API_URL: 'http://dashboard:8000'
      KIOSK_API_TOKEN: '${KIOSK_API_TOKEN:-}'
      # MQTT configuration for RFID access card programming
      MQTT_HOST: 'mosquitto'
      MQTT_PORT: '1883'
      MQTT_USER: '${MQTT_USER:-}'
      MQTT_PASSWORD: '${MQTT_PASSWORD:-}'
      MQTT_ENABLED: 'true'
    working_dir: /app
    volumes:
      - ../kiosk:/app:rw
      - ~/.cache/pip:/root/.cache/pip:rw
    command: >
      sh -c "
        apt-get update && apt-get install -y --no-install-recommends tesseract-ocr libgl1 libglib2.0-0 &&
        pip install -r requirements.txt gunicorn &&
        python manage.py migrate --noinput &&
        rm -rf staticfiles && python manage.py collectstatic --noinput &&
        gunicorn --bind 0.0.0.0:8000 kiosk_project.wsgi:application --workers 2
      "
    depends_on:
      - mrz-backend
      - mosquitto
      - dashboard
    restart: unless-stopped
    networks:
      - kiosk-network
      - default

  # MRZ Backend Microservice (Flask) - API only, no camera hardware
  mrz-backend:
    <<: *python-base
    container_name: mrz-backend
    environment:
      PYTHONUNBUFFERED: '1'
    working_dir: /app
    volumes:
      - ../kiosk/app:/app:rw
      - mrz_logs:/app/Logs
      - ~/.cache/pip:/root/.cache/pip:rw
    command: >
      sh -c "
        apt-get update && apt-get install -y --no-install-recommends tesseract-ocr libgl1 libglib2.0-0 &&
        pip install -r requirements.txt flask gunicorn &&
        gunicorn --bind 0.0.0.0:5000 app:app --workers 2
      "
    restart: unless-stopped
    networks:
      - kiosk-network

networks:
  kiosk-network:
    driver: bridge
  default:
    driver: bridge

volumes:
  # Data Services
  influxdb-data:
  influxdb-config:
  postgres-data:
  mosquitto-data:
  mosquitto-logs:

  # Grafana
  grafana-data:
  grafana-logs:

  # Node-RED
  nodered-data:

  # Kiosk
  mrz_logs:

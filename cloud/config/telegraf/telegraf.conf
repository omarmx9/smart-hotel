[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_jitter = "0s"
  precision = ""
  debug = true
  quiet = false
  logfile = ""

# ============================================================================
# OUTPUT - InfluxDB v2
# ============================================================================
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "$INFLUX_TOKEN"
  organization = "$INFLUX_ORG"
  bucket = "$INFLUX_BUCKET"

# ============================================================================
# MQTT Consumer - ESP32 Room Sensors (JSON format - PREFERRED)
# ============================================================================
# Topic structure: hotel/<room_id>/telemetry/json
# ESP32 sends JSON payloads with all sensor data in a single message
# {
#   "room": "Room101",
#   "timestamp": 123456789,
#   "sensors": {
#     "temperature": 25.5,
#     "humidity": 60.0,
#     "light_percent": 75,
#     "gas_level": 120,
#     "target_temp": 24.0
#   },
#   "state": {
#     "thermostat_mode": "AUTO",
#     "fan_speed": "LOW",
#     "heating": false,
#     "room_mode": "MANUAL",
#     "led1": "ON",
#     "led2": "OFF"
#   }
# }
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  topics = [
    "hotel/+/telemetry/json"
  ]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-esp-json-telemetry"
  data_format = "json_v2"
  name_override = "esp_telemetry"
  
  # Parse JSON telemetry from ESP32
  [[inputs.mqtt_consumer.json_v2]]
    # Extract room ID from JSON body as a tag
    [[inputs.mqtt_consumer.json_v2.tag]]
      path = "room"
      rename = "room_id"
    
    # Timestamp from ESP32 (milliseconds since boot or epoch)
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "timestamp"
      type = "int"
    
    # Sensor readings - flattened from sensors object
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sensors.temperature"
      rename = "temperature"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sensors.humidity"
      rename = "humidity"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sensors.light_percent"
      rename = "light_percent"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sensors.gas_level"
      rename = "gas_level"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "sensors.target_temp"
      rename = "target_temp"
      type = "float"
    
    # State information - flattened from state object
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.thermostat_mode"
      rename = "thermostat_mode"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.fan_speed"
      rename = "fan_speed"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.heating"
      rename = "heating"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.room_mode"
      rename = "room_mode"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.led1"
      rename = "led1"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "state.led2"
      rename = "led2"
      type = "string"
  
  # Also extract room ID from topic for redundancy
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "hotel/+/telemetry/json"
    tags = "_/room_id/_/_"

# ============================================================================
# MQTT Consumer - ESP32 Room Sensors (Legacy plain value format)
# ============================================================================
# Topic structure: hotel/<room_no>/telemetry/<sensor>
# ESP32 sends plain numeric values like: 22.50 (not JSON)
# DEPRECATED: Keep for backward compatibility during transition
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  # Optional MQTT authentication (via environment variables)
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  topics = [
    "hotel/+/telemetry/temperature",
    "hotel/+/telemetry/humidity",
    "hotel/+/telemetry/luminosity",
    "hotel/+/telemetry/ldr_percent",
    "hotel/+/telemetry/gas"
  ]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-esp-telemetry-legacy"
  data_format = "value"
  data_type = "float"
  name_override = "esp_telemetry"
  
  # Extract room ID and sensor type from topic
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "hotel/+/telemetry/+"
    tags = "_/room_id/_/sensor_type"

# ============================================================================
# MQTT Consumer - ESP32-CAM Face Recognition Events
# ============================================================================
# Topic: hotel/kiosk/Room1/FaceRecognition/Authentication
# These are ESP32-CAM based face recognition results
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  topics = [
    "hotel/kiosk/+/FaceRecognition/Authentication",
    "hotel/+/FaceRecognition/+",
    "hotel/esp32cam/+"
  ]
  qos = 1
  connection_timeout = "30s"
  client_id = "telegraf-espcam-facerecog"
  data_format = "json"
  json_string_fields = ["name", "status", "result", "action", "person"]
  name_override = "face_recognition"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "hotel/kiosk/+/FaceRecognition/Authentication"
    tags = "_/_/room_id/_/_"

# ============================================================================
# MQTT Consumer - ESP32 Status/Heartbeat
# ============================================================================
# ESP32 devices publish their status here as plain strings (ON/OFF/AUTO/MANUAL)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  topics = [
    "hotel/+/status/+",
    "hotel/+/heartbeat"
  ]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-esp-status"
  data_format = "value"
  data_type = "string"
  name_override = "esp_status"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "hotel/+/status/+"
    tags = "_/room_id/_/status_type"

# ============================================================================
# MQTT Consumer - ESP32 Access Control Events (Door locks, RFID)
# ============================================================================
# These may send either plain strings or JSON depending on firmware
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"
  topics = [
    "hotel/+/access/+",
    "hotel/+/door/+",
    "hotel/+/rfid/+"
  ]
  qos = 1
  connection_timeout = "30s"
  client_id = "telegraf-esp-access"
  data_format = "value"
  data_type = "string"
  name_override = "access_events"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "hotel/+/access/+"
    tags = "_/room_id/_/event_type"

# ============================================================================
# NOTE: System metrics (CPU, memory, disk, net) are REMOVED
# This Telegraf instance only collects ESP and ESP-CAM data
# ============================================================================
